name: nuke-run
on:
  push:                   # pushでdry-run（確認）する
    branches: [ main ]
  workflow_dispatch:      # 実行は手動でのみ実行可能（実削除用）

jobs:
  run_aws_nuke:
    runs-on: ubuntu-latest
    permissions:
      id-token: write
      contents: read
    steps:
      - uses: actions/checkout@v4

      - name: Configure AWS credentials
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: ${{ secrets.AWS_ASSUMEROLE }}
          aws-region: ap-northeast-1

      - name: Show caller identity
        run: aws sts get-caller-identity

      - name: Install AWS Nuke
        run: |
          wget https://github.com/ekristen/aws-nuke/releases/download/v${{ env.AWS_NUKE_VERSION }}/aws-nuke-v${{ env.AWS_NUKE_VERSION }}-linux-amd64.tar.gz
          tar -xzf aws-nuke-v${{ env.AWS_NUKE_VERSION }}-linux-amd64.tar.gz
          ./aws-nuke version

      - name: Dry-run aws-nuke (automatic on push)
        if: github.event_name == 'push'
        run: |
          ./aws-nuke -c ./nuke-config.yml 2>&1 | tee nuke-dryrun.txt
        env:
          AWS_REGION: ap-northeast-1

      - name: Upload dry-run logs
        if: github.event_name == 'push'
        uses: actions/upload-artifact@v4
        with:
          name: nuke-dryrun-logs
          path: nuke-dryrun.txt

      - name: Run aws-nuke (REAL) — manual only
        if: github.event_name == 'workflow_dispatch'
        run: |
          ./aws-nuke nuke -c ./nuke-config.yml --no-dry-run --no-prompt 2>&1 | tee nuke-run.txt
        env:
          AWS_REGION: ap-northeast-1

      - name: Upload run logs
        if: github.event_name == 'workflow_dispatch'
        uses: actions/upload-artifact@v4
        with:
          name: nuke-run-logs
          path: nuke-run.txt
